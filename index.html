<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>NAMKI PROJECT</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f172a; --panel:#0b1220; --line:#1f2937; --fg:#e2e8f0; --muted:#94a3b8; --accent:#22c55e; --danger:#f87171; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--fg); font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #scene{ min-height:100dvh; display:flex; align-items:center; justify-content:center; }

    /* 이미지 씬 래퍼 */
    .scene-wrap{ position:relative; width:100%; height:100dvh; overflow:hidden; }
    .scene-wrap img.bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; }

    /* 모달 베이스 */
    #modal[hidden]{ display:none; }
    #modal{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.5); backdrop-filter:blur(2px); padding:16px; }
    .panel{ width:min(520px,92vw); background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:18px; position:relative; box-shadow:0 14px 40px rgba(0,0,0,.45); overflow:hidden; }
    .panel h3{ margin:0 0 10px; font-weight:900; }
    .close{ position:absolute; top:10px; right:10px; background:transparent; color:#0b1b2b; border:0; font-size:20px; line-height:1; }
    .row{ display:flex; align-items:center; gap:12px; }
    .inp{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #243041; background:#0a1220; color:var(--fg); font-size:16px; }
    .errTxt{ color:var(--danger); font-weight:700; margin-top:8px; }
    .primary{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #16a34a33; background:linear-gradient(180deg,#16a34a,#16a34a) padding-box, linear-gradient(180deg,#16a34a55,#16a34a00) border-box; color:#fff; font-weight:900; margin-top:12px; }

    /* 스킨: 씬1(ver3), 씬2(ver4) → 글자색/입력칸 글자색 모두 검정 */
    .panel.skin-v3, .panel.skin-v4{ background:#cfe1f3; border:2px solid #79a8d9; color:#0b1b2b; }
    .panel.skin-v3 h3, .panel.skin-v4 h3{ color:#0b1b2b; }
    .panel.skin-v3 .inp, .panel.skin-v4 .inp{ background:#fff; border:3px solid #69a3db; border-radius:8px; font-size:18px; color:#0b1b2b; }
    .panel.skin-v3 .inp::placeholder, .panel.skin-v4 .inp::placeholder{ color:#0b1b2b; opacity:.8; }
    .panel.skin-v3 .primary, .panel.skin-v4 .primary{ background:#5a97d1; border:2px solid #0b0b0b; height:48px; font-size:18px; }
    .panel.skin-v4 .colon{ font-weight:900; font-size:24px; color:#0b1b2b; }

    /* 씬3 전용 모달 스킨 (디자인 시안 반영) */
    .panel.skin-date{ background:#cfe1f3; border:2px solid #79a8d9; color:#0b1b2b; }
    .panel.skin-date h3{ color:#0b1b2b; font-size:20px; }
    .panel.skin-date .inp.date-box{
      background:#fff; border:3px solid #69a3db; border-radius:8px;
      height:44px; font-weight:800; font-size:18px; text-align:center; letter-spacing:.5px; color:#0b1b2b;
      width:clamp(56px, 18vw, 88px); /* 한 줄 유지용 */
    }
    .panel.skin-date .unit{ color:#fff; font-weight:900; margin:0 6px; font-size:18px; text-shadow:0 1px 0 rgba(0,0,0,.2); }
    .panel.skin-date .primary{ background:#5a97d1; border:2px solid #0b0b0b; box-shadow:none; font-size:18px; height:44px; }

    .date-row{ display:flex; align-items:center; justify-content:center; gap:6px; margin-top:12px; flex-wrap:nowrap; white-space:nowrap; }

    /* 자동 시퀀스 레이아웃 */
    .auto-wrap{ position:relative; display:grid; place-items:center; width:100%; height:100dvh; background:#000; color:#fff; overflow:hidden; }
    /* 날짜: 처음엔 중앙 상단(겹침 방지), 이후 드롭되며 정중앙 */
    .date{ position:absolute; top:10%; left:50%; transform:translate(-50%,0); font-size:44px; font-weight:900; letter-spacing:.5px; font-variant-numeric: tabular-nums; }
    @keyframes drop{ to{ top:50%; transform:translate(-50%,-50%); } }
    /* “무언가 잘못됐다.” 및 이후 문구는 정중앙 */
    .msg{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:32px; font-weight:900; opacity:0; }
    .msg.show{ animation:msgIn .25s forwards; }
    .msg.hide{ animation:fadeOut .35s forwards; }
    /* ERROR!! 난수 배치 */
    .errs{ position:absolute; inset:0; pointer-events:none; }
    .errLine{ position:absolute; color:#ef4444; font-style:italic; font-weight:900; opacity:0; font-size:clamp(18px,4vw,36px); text-shadow:0 2px 0 rgba(0,0,0,.4); animation:errIn .28s forwards; will-change: transform, opacity; }
    .errs.fade-out{ animation:fadeOut .35s forwards; }

    .numWrap{ display:inline-flex; align-items:baseline; gap:4px; }
    .date .mm, .date .dd{ display:inline-flex; gap:2px; }
    .date .d{ display:inline-block; width:0.62em; text-align:center; }

    @keyframes msgIn{ from{transform:translate(-50%,6px);opacity:0} to{transform:translate(-50%, -50%);opacity:1} }
    @keyframes errIn{ from{transform:translateY(6px);opacity:0} to{transform:translateY(0);opacity:1} }
    @keyframes fadeOut{ to{opacity:0} }

    /* 플로팅 버튼: 이미지 아이콘 사용 */
    #sync{ position:fixed; right:16px; bottom:20px; background:transparent; border:none; padding:0; }
    #sync img{ width:68px; height:68px; display:block; filter: drop-shadow(0 10px 24px rgba(34,197,94,.35)); }

    /* 토스트 */
    .toast{ position:fixed; left:50%; bottom:86px; transform:translateX(-50%); background:#0a1220; border:1px solid var(--line); color:#e2e8f0; padding:10px 12px; border-radius:10px; opacity:0; pointer-events:none; }
    .toast.show{ animation:toastIn .25s forwards, toastOut .25s 2.2s forwards; }
    @keyframes toastIn{ to{ opacity:1; transform:translate(-50%,-4px);} }
    @keyframes toastOut{ to{ opacity:0; transform:translate(-50%,4px);} }
  </style>
</head>
<body>
  <main id="scene"></main>

  <!-- 모달 -->
  <div id="modal" hidden aria-modal="true" role="dialog" aria-labelledby="modalTitle">
    <div class="panel">
      <button id="close" class="close" aria-label="닫기">✕</button>
      <h3 id="modalTitle">암호를 입력하세요.</h3>
      <div id="modalBody"></div>
      <p id="errTxt" class="errTxt" hidden>암호가 틀렸습니다.</p>
      <button id="submit" class="primary">확인</button>
    </div>
  </div>

  <!-- 이미지 아이콘 버튼 (첨부한 동기화 아이콘 사용) -->
  <button id="sync" aria-label="동기화">
    <img src="./assets/sync.png" alt="동기화">
  </button>

  <script>
    // ==== 설정: 업로드하신 파일명을 다음 경로로 두시면 즉시 동작합니다 ====
    // ./assets/씬1 합본.png   (씬1 배경)
    // ./assets/씬2 합본.png   (씬2 배경)
    // ./assets/scene3.png     (씬3 배경)
    // ./assets/암호입력창(ver.3).png (씬1 모달 배경 스킨)
    // ./assets/암호입력창(ver.4).png (씬2 모달 배경 스킨)
    // ./assets/암호입력창(ver.5).png (씬3 모달 배경 스킨)

    const PATH = {
      scene1: "./assets/씬1 합본.png",
      scene2: "./assets/씬2 합본.png",
      scene3: "./assets/scene3.png",
      modalSkinV3: "./assets/암호입력창(ver.3).png",
      modalSkinV4: "./assets/암호입력창(ver.4).png",
      modalSkinScene3: "./assets/암호입력창(ver.5).png",
    };

    // ===== 상태 및 유틸 =====
    const $ = s => document.querySelector(s);
    const scene = $("#scene");
    const modal = $("#modal");
    const modalBody = $("#modalBody");
    const errTxt = $("#errTxt");
    const toast = $("#toast");
    const syncBtn = $("#sync");

    let stage = Number(localStorage.getItem("stage") || 1);
    let inputRefs = null;

    function saveStage(){ localStorage.setItem("stage", String(stage)); }
    function vibrate(ms){ if (navigator.vibrate) navigator.vibrate(ms); }
    function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function showToast(){}

    function updateSyncVisibility(){ syncBtn.style.display = (stage >= 4 ? 'none' : 'block'); }

    // ===== 답변 해시(plaintext 미포함) =====
    const ANSWER_HASHES = new Map([
      [1, "307a88de1bc3a173a9520564c2d7bd52e79429471def43e32668030dff6045ef"], // "kimminji"
      [2, "a5bda57a2d1f524d4d1c4ba7fa0d23bce8d7d5cb8b112a26db870c4d2868ff4c"], // "12:56"
      [3, "eaa6f506fa49ff67a3896fc3fdeed5919fec6f75f5b21de800e298216c7e8aab"], // "2017 03 28"
    ]);

    async function sha256(str){
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", buf);
      return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    async function verify(stage, value){
      const h = await sha256(value.trim());
      return h === ANSWER_HASHES.get(stage);
    }

    // ===== 초기 렌더 =====
    renderStage();

    $("#sync").addEventListener("click", () => {
      if (stage === 1)      openPasswordModal({ type: "text", skin: 'v3', placeholder: "암호 입력" });
      else if (stage === 2) openPasswordModal({ type: "time-dual", skin: 'v4' });
      else if (stage === 3) openPasswordModal({ type: "date-kr", skin: 'date' });
      else if (stage >= 4) { showToast(); }
    });
    $("#close").addEventListener("click", () => { modal.hidden = true; });
    $("#submit").addEventListener("click", onSubmitPassword);

    function renderStage(){
      if (stage === 1){
        scene.innerHTML = `
          <div class="scene-wrap">
            <img src="${PATH.scene1}" class="bg" alt="씬1 배경">
          </div>`;
      } else if (stage === 2){
        scene.innerHTML = `
          <div class="scene-wrap">
            <img src="${PATH.scene2}" class="bg" alt="씬2 배경">
          </div>`;
      } else if (stage === 3){
        scene.innerHTML = `
          <div class="scene-wrap">
            <img src="${PATH.scene3}" class="bg" alt="씬3 배경">
          </div>`;
      } else if (stage >= 4){
        playAutoSequence();
      }
      updateSyncVisibility();
    }

    // ===== 모달 =====
    function openPasswordModal(opts){
      modal.hidden = false;
      errTxt.hidden = true;

      const panel = modal.querySelector('.panel');
      panel.classList.remove('skin-v3','skin-v4','skin-date');
      if (opts.skin === 'v3') panel.classList.add('skin-v3');
      if (opts.skin === 'v4') panel.classList.add('skin-v4');
      if (opts.skin === 'date') panel.classList.add('skin-date');

      // 스킨별 배경
      if (opts.skin === 'v3') panel.style.background = `#cfe1f3 url(${PATH.modalSkinV3}) center/cover no-repeat`;
      else if (opts.skin === 'v4') panel.style.background = `#cfe1f3 url(${PATH.modalSkinV4}) center/cover no-repeat`;
      else if (opts.skin === 'date') panel.style.background = `#cfe1f3 url(${PATH.modalSkinScene3}) center/cover no-repeat`;
      else panel.style.background = '';

      const title = document.getElementById('modalTitle');
      title.textContent = '암호를 입력하세요.';

      if (opts.type === "text"){
        modalBody.innerHTML = `<input id="pw1" class="inp" placeholder="${opts.placeholder||''}" autocomplete="off" />`;
        inputRefs = { a: document.getElementById('pw1') };
        inputRefs.a.focus();
      } else if (opts.type === "time-dual"){
        modalBody.innerHTML = `
          <div class="row">
            <input id="tL" class="inp" inputmode="numeric" maxlength="2" placeholder="hh" autocomplete="one-time-code" style="max-width:220px;" />
            <span class="colon">:</span>
            <input id="tR" class="inp" inputmode="numeric" maxlength="2" placeholder="mm" style="max-width:220px;" />
          </div>`;
        inputRefs = { l: document.getElementById('tL'), r: document.getElementById('tR') };
        inputRefs.l.focus();
      } else if (opts.type === "date-kr"){
        modalBody.innerHTML = `
          <div class="date-row">
            <input id="yy" class="inp date-box" inputmode="numeric" maxlength="4" />
            <span class="unit">년</span>
            <input id="mm" class="inp date-box" inputmode="numeric" maxlength="2" />
            <span class="unit">월</span>
            <input id="dd" class="inp date-box" inputmode="numeric" maxlength="2" />
            <span class="unit">일</span>
          </div>`;
        inputRefs = { yy: document.getElementById('yy'), mm: document.getElementById('mm'), dd: document.getElementById('dd') };
        inputRefs.yy.focus();

        // 숫자만 허용 + 자동 이동
        const digitsOnly = el => { el.value = [...el.value].filter(c => c >= '0' && c <= '9').join(''); };
        [inputRefs.yy, inputRefs.mm, inputRefs.dd].forEach((el, i, arr) => {
          el.addEventListener('input', () => {
            digitsOnly(el);
            const max = Number(el.getAttribute('maxlength')) || 2;
            if (el.value.length >= max && arr[i+1]) arr[i+1].focus();
          });
        });
      }
    }

    async function onSubmitPassword(){
      let value = "";
      if (stage === 1) {
        value = inputRefs.a.value.trim();
      } else if (stage === 2) {
        value = `${inputRefs.l.value.trim()}:${inputRefs.r.value.trim()}`;
      } else if (stage === 3) {
        const yy = inputRefs.yy.value.trim();
        const mm = inputRefs.mm.value.trim().padStart(2,'0');
        const dd = inputRefs.dd.value.trim().padStart(2,'0');
        value = `${yy} ${mm} ${dd}`; // '2017 03 28' 형식
      }

      const ok = await verify(stage, value);
      if (!ok){ errTxt.hidden = false; vibrate(20); return; }
      modal.hidden = true; stage++; saveStage(); renderStage();
    }

    // ===== 자동 시퀀스(S4~S6) =====
    async function playAutoSequence(){
      scene.innerHTML = `
        <div class="auto-wrap">
          <div class="date" id="date">2017 03 28</div>
          <div class="msg" id="msg">무언가 잘못됐다.</div>
          <div class="errs" id="errs"></div>
        </div>`;
      updateSyncVisibility(); // 씬3 이후 동기화 버튼 숨김

      // 1) 안내 메시지 표시 후 사라짐 (정중앙), 날짜는 상단 중앙에 고정
      const msg = document.getElementById('msg');
      await wait(150);
      msg.classList.add('show');
      await wait(900);
      msg.classList.remove('show');
      msg.classList.add('hide');
      await wait(350);

      // 2) ERROR!! 를 화면 왼쪽 치우침 완화: 전체(6%~68%, 10%~90%) 범위에 더 많이 순차 표출
      const ERR_COUNT = 36;
      for (let i=0;i<ERR_COUNT;i++){
        addErrorLine(i);
        await wait(110 + Math.random()*70);
      }

      // 3) 일괄 소거 + 날짜 중앙으로 드롭
      await wait(500);
      document.getElementById('errs').classList.add('fade-out');
      const d = document.getElementById('date');
      d.classList.add('drop');
      await wait(900);

      // 4) 연도 카운트업 → 자리 교체 (이 시점부턴 모든 텍스트가 정중앙)
      await animateYearCount(d, 2017, 2025, "03", "28");
      await swapDigits(d, "2025", "03", "28", "08", "23");

      stage = 6; saveStage();
    }

    function addErrorLine(i){
      const container = document.getElementById('errs');
      const el = document.createElement('div');
      el.className = 'errLine';
      el.textContent = 'ERROR!!';
      // 화면의 좌우 비율이 바뀌지 않도록, 컨테이너 내부에서만 렌더링(오버플로는 auto-wrap에서 잘림)
      // 분포: left 6%~68%로 약간 왼쪽 치우치게, top 10%~90%
      const left = 6 + Math.random()*62;   // 6% ~ 68%
      const top  = 10 + Math.random()*80;  // 10% ~ 90%
      const rot  = -18 + Math.random()*36; // -18deg ~ 18deg
      el.style.left = left + '%';
      el.style.top = top + '%';
      el.style.transform = `translate(-50%,-50%) rotate(${rot}deg)`;
      el.style.animationDelay = `${i*0.02}s`;
      container.appendChild(el);
    }

    async function animateYearCount(el, from, to, mm, dd){
      const duration = 1200; const t0 = performance.now();
      return new Promise(resolve=>{
        function frame(t){
          const p = Math.min(1, (t-t0)/duration);
          const y = Math.round(from + (to-from)*p);
          el.textContent = `${y} ${mm} ${dd}`;
          if (p < 1) requestAnimationFrame(frame); else resolve();
        }
        requestAnimationFrame(frame);
      });
    }

    async function swapDigits(el, yyyy, mmFrom, ddFrom, mmTo, ddTo){
      // 0과 2는 고정, 3과 8만 서로의 자리로 '부드럽게' 이동
      el.innerHTML = `
        <span class="numWrap">
          <span class="yyyy">${yyyy}</span>
          <span class="mm"><span class="d m1">${mmFrom[0]}</span><span class="d m2">${mmFrom[1]}</span></span>
          <span>&nbsp;</span>
          <span class="dd"><span class="d d1">${ddFrom[0]}</span><span class="d d2">${ddFrom[1]}</span></span>
        </span>`;
      await wait(1500);

      const m2 = el.querySelector('.m2');
      const d2 = el.querySelector('.d2');
      const r1 = m2.getBoundingClientRect();
      const r2 = d2.getBoundingClientRect();
      const dx12 = r2.left - r1.left;
      const dy12 = r2.top - r1.top;
      const dx21 = r1.left - r2.left;
      const dy21 = r1.top - r2.top;

      // ⏱ 교체 시간(ms) — 원하는 길이로 자유롭게 수정하세요 (예: 3000 = 3초)
      const D = 3500; 
      const opts = { duration: D, easing: 'cubic-bezier(.2,.8,.2,1)', fill: 'forwards' };

      const a1 = m2.animate([{transform:'translate(0,0)'},{transform:`translate(${dx12}px,${dy12}px)`}], opts);
      const a2 = d2.animate([{transform:'translate(0,0)'},{transform:`translate(${dx21}px,${dy21}px)`}], opts);
      vibrate(12);

      // 애니메이션이 '정확히 끝난 뒤' 교체 → duration 변경해도 타이밍이 어긋나지 않음
      try {
        await Promise.all([a1.finished, a2.finished]);
      } catch (e) {
        // 일부 브라우저 호환: finished 미지원 시 시간으로 대체
        await wait(D);
      }

      m2.style.opacity = '0';
      d2.style.opacity = '0';
      await wait(40);
      el.textContent = `${yyyy} ${mmTo} ${ddTo}`;
    }
  </script>
</body>
</html>
